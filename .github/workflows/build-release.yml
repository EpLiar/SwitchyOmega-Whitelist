name: Build and publish .sorl (latest release)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write

concurrency:
  group: sorl-latest
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      RELEASE_TAG: auto-latest
      RELEASE_TITLE: Auto-generated SwitchyOmega rules
      ASSET_PATH: OmegaRules_auto_switch.sorl
      ASSET_NAME: OmegaRules_auto_switch.sorl
      DLC_DIR: dlc

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Clone dlc
        shell: bash
        run: |
          set -euo pipefail
          rm -rf "$DLC_DIR"
          git clone --depth 1 https://github.com/v2fly/domain-list-community.git "$DLC_DIR"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - name: Generate .sorl
        shell: bash
        run: |
          set -euo pipefail
          python generate_sorl.py
          test -f "OmegaRules_auto_switch.sorl"

      - name: Create or update release (and upload asset)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          NOTES="Auto-generated by GitHub Actions Generated at (UTC): $(date -u '+%Y-%m-%d %H:%M:%SZ')"
          if gh release view "$RELEASE_TAG" >/dev/null 2>&1; then
            gh release edit "$RELEASE_TAG" --title "$RELEASE_TITLE" --notes "$NOTES"
          else
            gh release create "$RELEASE_TAG" --title "$RELEASE_TITLE" --notes "$NOTES"
          fi
          gh release upload "$RELEASE_TAG" "$ASSET_PATH#$ASSET_NAME" --clobber
